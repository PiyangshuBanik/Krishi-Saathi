<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crop Price Tracker</title>

  <link rel="icon" type="image/png" href="/static/images/logo.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    /* Import theme system */
    @import url('/static/css/theme.css');

    * { box-sizing: border-box; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
    body { margin: 0; padding: 20px; font-family: "Segoe UI", sans-serif; background-color: var(--bg-secondary, #f1f8e9); color: var(--text-primary, #333); display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
    .header { width: 100%; max-width: 800px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .back-button { background-color: #4caf50; color: white; padding: 10px 20px; border: none; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3); }
    .back-button:hover { background-color: #45a049; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4); }
    .back-button::before { content: "‚Üê"; font-size: 16px; }
    h2 { margin: 0; font-size: 32px; color: var(--text-primary); text-align: center; font-weight: 700; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); flex: 1; }
    .form-container { background-color: var(--bg-primary, #ffffff); padding: 35px; border-radius: 20px; box-shadow: 0 12px 40px var(--shadow-medium, rgba(0, 0, 0, 0.15)); width: 100%; max-width: 600px; margin-bottom: 30px; animation: slideUp 0.6s ease-out; }
    .form-row { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
    .form-label { font-weight: 600; color: var(--text-secondary); font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
    select { padding: 15px; font-size: 15px; border-radius: 12px; border: 2px solid var(--border-color); transition: all 0.3s ease; background-color: var(--bg-secondary); color: var(--text-primary); cursor: pointer; }
    select:focus { border-color: #2e7d32; outline: none; background-color: var(--bg-primary); box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1); }
    select:hover { border-color: #4caf50; }
    select:disabled { background-color: #f5f5f5; cursor: not-allowed; opacity: 0.6; }
    .submit-button { background: linear-gradient(135deg, #2e7d32, #4caf50); color: white; padding: 15px; border: none; border-radius: 12px; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; margin-top: 10px; box-shadow: 0 6px 20px rgba(46, 125, 50, 0.3); }
    .submit-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(46, 125, 50, 0.4); }
    .submit-button:active:not(:disabled) { transform: translateY(0); }
    .submit-button:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
    .error { background: linear-gradient(135deg, #ffebee, #ffe6e6); color: #b71c1c; padding: 15px 20px; border: 1px solid #ef9a9a; border-radius: 12px; margin-top: 20px; width: 100%; max-width: 600px; font-weight: 500; box-shadow: 0 4px 12px rgba(183, 28, 28, 0.1); }
    .results-container { width: 100%; max-width: 800px; margin-top: 20px; }
    h3 { margin: 0 0 20px 0; color: var(--text-primary); font-size: 24px; font-weight: 700; text-align: center; }
    .price-grid { display: grid; gap: 15px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    .price-card { background: var(--bg-primary); padding: 20px; border-left: 5px solid #81c784; border-radius: 12px; font-size: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); transition: all 0.3s ease; border: 1px solid var(--border-color); opacity: 0; animation: fadeIn 0.5s ease-out forwards; }
    .price-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); border-left-color: #4caf50; }
    .price-date { font-weight: 700; color: var(--text-secondary); font-size: 14px; margin-bottom: 8px; }
    .price-amount { font-size: 20px; font-weight: 800; color: var(--text-primary); margin-bottom: 5px; }
    .price-location { color: var(--text-primary); opacity: 0.8; font-size: 14px; font-weight: 500; }
    .loading-spinner::after { content: ""; display: inline-block; width: 16px; height: 16px; border: 2px solid #ccc; border-top: 2px solid #2e7d32; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; vertical-align: middle; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @media (max-width: 768px) { .header { flex-direction: column; gap: 15px; } h2 { font-size: 28px; } .form-container { padding: 25px 20px; } .price-grid { grid-template-columns: 1fr; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { to { opacity: 1; } }
    .price-card:nth-child(1) { animation-delay: 0.1s; } .price-card:nth-child(2) { animation-delay: 0.2s; } .price-card:nth-child(3) { animation-delay: 0.3s; } .price-card:nth-child(4) { animation-delay: 0.4s; } .price-card:nth-child(5) { animation-delay: 0.5s; }
  </style>
</head>

<body>
  <button class="theme-toggle" aria-label="Toggle dark/light mode" style="background: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary); position: absolute; top: 20px; right: 20px; z-index: 1000; padding: 10px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer;">
    <i class="fas fa-sun sun-icon"></i>
    <i class="fas fa-moon moon-icon"></i>
  </button>
  <div class="header">
    <a href="/main.html" class="back-button">Back to Main</a>
    <h2>üåæ Crop Price Tracker</h2>
    <div style="width: 120px; flex-shrink: 0;"></div>
  </div>

  <div class="form-container">
    <form method="POST" id="priceForm">
      <div class="form-row">
        <label for="crop" class="form-label">Select Crop</label>
        <select name="crop" id="crop" required>
          <option value="">-- Choose your crop --</option>
          {% for crop in crops %}
          <option value="{{ crop }}" {% if form_data.crop == crop %}selected{% endif %}>{{ crop }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-row">
        <label for="state" class="form-label">Select State</label>
        <select name="state" id="state" required disabled>
          <option value="">-- First select a crop --</option>
        </select>
      </div>

      <div class="form-row">
        <label for="market" class="form-label">Select Market</label>
        <select name="market" id="market" required disabled>
          <option value="">-- First select a state --</option>
        </select>
      </div>

      <button type="submit" class="submit-button" id="submitBtn" disabled>
        Track Prices
      </button>
    </form>
  </div>

  {% if error %}
  <div class="error"><strong>‚ö†Ô∏è Error:</strong> {{ error }}</div>
  {% endif %} 
  
  {% if result %}
  <div class="results-container">
    <h3>üìà Latest Prices for {{ form_data.crop }} in {{ form_data.market }}</h3>
    <div class="price-grid">
      {% for row in result %}
      <div class="price-card">
        <div class="price-date">üìÖ {{ row['arrival_date'] }}</div>
        <div class="price-amount">üí∞ ‚Çπ{{ row['modal_price'] }} / quintal</div>
        <div class="price-location">üìç {{ row['market'] }}, {{ row['state'] }}</div>
      </div>
      {% else %}
       <p style="text-align: center;">No results to display.</p>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const cropSelect = document.getElementById("crop");
      const stateSelect = document.getElementById("state");
      const marketSelect = document.getElementById("market");
      const submitBtn = document.getElementById("submitBtn");

      function updateSubmitButton() {
        const isFormComplete = cropSelect.value && stateSelect.value && marketSelect.value;
        submitBtn.disabled = !isFormComplete;
      }

      function setSelectLoading(selectElement, isLoading, message) {
        selectElement.disabled = isLoading;
        if (isLoading) {
          selectElement.innerHTML = `<option value="">${message}</option>`;
        }
      }

      cropSelect.addEventListener("change", function () {
        const cropValue = this.value;
        setSelectLoading(stateSelect, true, "Loading states...");
        marketSelect.innerHTML = '<option value="">-- First select a state --</option>';
        marketSelect.disabled = true;

        if (!cropValue) {
          setSelectLoading(stateSelect, true, "-- First select a crop --");
          updateSubmitButton();
          return;
        }

        fetch("/get_states?crop=" + cropValue)
          .then((res) => res.json())
          .then((states) => {
            setSelectLoading(stateSelect, false);
            stateSelect.innerHTML = '<option value="">-- Select State --</option>';
            states.forEach((state) => {
              stateSelect.innerHTML += `<option value="${state}">${state}</option>`;
            });
          })
          .catch((error) => {
            console.error("Error fetching states:", error);
            setSelectLoading(stateSelect, false);
            stateSelect.innerHTML = '<option value="">-- Error loading --</option>';
          });
      });

      stateSelect.addEventListener("change", function () {
        const crop = cropSelect.value;
        const state = this.value;
        
        setSelectLoading(marketSelect, true, "Loading markets...");

        if (!state) {
            setSelectLoading(marketSelect, true, "-- First select a state --");
            updateSubmitButton();
            return;
        }

        fetch(`/get_markets?crop=${crop}&state=${state}`)
          .then((res) => res.json())
          .then((markets) => {
            setSelectLoading(marketSelect, false);
            marketSelect.innerHTML = '<option value="">-- Select Market --</option>';
            markets.forEach((market) => {
              marketSelect.innerHTML += `<option value="${market}">${market}</option>`;
            });
          })
          .catch((error) => {
            console.error("Error fetching markets:", error);
            setSelectLoading(marketSelect, false);
            marketSelect.innerHTML = '<option value="">-- Error loading --</option>';
          });
      });

      marketSelect.addEventListener("change", updateSubmitButton);

      document.getElementById("priceForm").addEventListener("submit", function () {
          submitBtn.disabled = true;
          submitBtn.innerHTML = "Fetching Prices... <span class='loading-spinner'></span>";
      });

      updateSubmitButton();
    });
  </script>
  <script src="/static/js/theme.js"></script>
</body>
</html>